{
  "hash": "967821f9d05e79baeb30bb0d65a6dd5a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Analyzing trends in time series maps using R\"\nformat:\n  html:\n    code-overflow: wrap\n    code-link: true\nnumber-sections: false\nnumber-depth: 4\ndate: 2025-03-14\nhighlight-style: github\nsesion: 4\nauthor: \n  - name: \"Javier Martínez-López\"\n    orcid: 0000-0002-0825-7252\n    email: javier.martinez@ugr.es\n    affiliation: Departamento de Ecología, Universidad de Granada\ncrossref:\n  fig-title: Figura     # (default is \"Figure\")\n  tbl-title: Tabla     # (default is \"Table\")\n  title-delim: .     # (default is \":\")\n  fig-prefix: Figura\n  tbl-prefix: Tabla\n  ref-hyperlink: true\n  sec-prefix: \"\"\n  sec-labels: alpha\n---\n\n\n\n# Objectives\n\nThe general objective of this session is to analyze **trends** in **yearly maps** that show the **mean photosynthetic activity (NDVI)** of Sierra Nevada vegetation cover from **2011 to 2020** using **R**.\n\n# R workflow\n\nWe will compute **Mann-Kendall** time series analysis on NDVI mean yearly maps.\n\n- First, you will need to download the yearly NDVI rasters from [this folder](https://drive.google.com/drive/folders/1hYvANE8gPovZ8PCJ6ZkrhcJAUSth23XV?usp=sharing).\n\n- Install and load the required packages:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Install the required packages\n\n#install.packages(\"zyp\")\n#install.packages(\"terra\")\n#install.packages(\"spatialEco\")\n\n# Load required packages\n\nlibrary(spatialEco)\nlibrary(terra)\n```\n:::\n\n\n\n- Create a **multiband** terra SpatRaster object containing each NDVI yearly raster as a layer.\n\n:::{.callout-warning}\nAll input raster files must have the same spatial extent and resolution!\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a multiband terra SpatRaster object with 10 layers\nr <- c(\n  rast('ndvi_2011.tif')\n  ,rast('ndvi_2012.tif')\n  ,rast('ndvi_2013.tif')\n  ,rast('ndvi_2014.tif')\n  ,rast('ndvi_2015.tif')\n  ,rast('ndvi_2016.tif')\n  ,rast('ndvi_2017.tif')\n  ,rast('ndvi_2018.tif')\n  ,rast('ndvi_2019.tif')\n  ,rast('ndvi_2020.tif')\n  )\n\nplot(r)  # to see all the maps\n```\n:::\n\n\n\n- **Resample** the input NDVI maps to approximately **200 meter resolution** using the **mean** value in order to decrease the computing time needed to perform the Mann-Kendall test.\n\n- Then, **export** the created object to a _.tif_ file since we will use this multi-band raster file to create trends graphs in QGIS.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Source: https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/\n\n# Aggregate the raster using 8 pixels within the horizontal and the vertical directions\n\nr8 <- aggregate(r, fact = 8) # approx. higher than 200m resolution\n\nwriteRaster(r8, 'input_ndvi_ts_scale8.tif', overwrite = T)\n```\n:::\n\n\n\n- Run the [Mann-Kendall](https://www.rdocumentation.org/packages/spatialEco/versions/2.0-2/topics/raster.kendall) test over all \"bands\".\n\n- This test is very useful to analyze data collected over time for consistently increasing or decreasing trends. Since it is a non-parameetric test, it can be used for all distributions. \n\nThe Mann Kendall test yield another raster spatial object containing **6 bands**. We will pay attention to these ones:\n\n- `slope`: Kendall's Sen slope. The median slope joining all pairs of observations expressed by quantity per unit of time. Negative values means negative trends and viceversa. 0 means that there is no trend.\n    \n- `p-value`: Kendall's two-sided test statistic. The significance, which represents the threshold for which the hypothesis that there is no trend is accepted. The trend is statistically significant when the p-value is less than 0.05.\n     \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmk <- raster.kendall(r8, method = \"none\")\n\nplot(mk)\n```\n:::\n\n\n- Mask out non-significant trends. Cell trend values with a p-value higher then 0.05 will be identified and masked out.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Reclass cells with slope values lower then 0.05 (TRUE) and the rest (FALSE)\nsignif <- mk$`p-value` < 0.05\n\nplot(signif)\n\n# New raster object containing original slope values\nmk_slope <- mk$slope\n\n# Assign NA value to all cells with p-value higher than the threshold (cells with signif == FALSE)\nmk_slope[!signif]<-NA\n\nplot(mk_slope)\n```\n:::\n\n\n\n\n- Export the _slope_ band to a raster _.tif_ file.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwriteRaster(mk_slope, 'output_mk_slope_scale8_signif.tif', overwrite = T) # only significant slope values\n\nwriteRaster(mk$slope, 'output_mk_slope_scale8.tif', overwrite = T) # all slope values\n```\n:::\n\n\n\n# Analysis of results using QGIS\n\n- Install the required plugins:\n\n  - Install a plugin called \"**Temporal/Spectral Profile tool**\". Menu **Plugins**->_Manage and install plugins_. \n\n  - Install a plugin called \"**HCMGIS**\". Menu **Plugins**->_Manage and install plugins_. \n\n- Add the following layers to an empty QGIS project:\n\n  - `output_mk_slope_scale8_signif.tif`: Raster file containing only significant slope values (NDVI trend) per pixel.\n\n  - `output_mk_slope_scale8.tif`: Raster file containing all slope values (NDVI trend) per pixel.\n\n  - `input_ndvi_ts_scale8.tif`: This a multiband raster image that contains the NDVI time series created in GEE (yearly values from 2011 to 2020).\n\n- Add a basemap. Menu _HCMGIS_->_Basemaps_->_Google Satellite Hybrid_.\n\n- Display `output_mk_slope_scale8` using a _singleband pseudocolor_ render type as shown below (_Double click_->_Symbology_): \n\n![](https://raw.githubusercontent.com/javimarlop/datasets/master/pictures/symbology_mk_slope_qgis.png)\n\n- Copy the style of this layer (Right click on `output_mk_slope_scale8`->_Styles_->_Copy Style_) to the `output_mk_slope_scale8_signif.tif` layer (Right click->_Styles_->_Paste Style_).\n- Finally, reorder the layers as follows in the Layers pane:\n\t1. `output_mk_slope_scale8_signif`\n\t2. `output_mk_slope_scale8`\n\t3. `Google Satellite Hybrid`\n\t4. `input_ndvi_ts_scale8`\n \n- We will build a graph showing the **NDVI trend** of any selected pixel. In order to do that, follow these steps within QGIS:\n\n\t- Make sure the `input_ndvi_ts_scale8` layer is activated and selected.\n\t- Menu _Plugins_->_Profile Tool_->_Temporal/Spectral Profile_\n\t- Click on any pixel of the selected layer and you will see a graph showing its NDVI trend. See image below:\n\n![](https://raw.githubusercontent.com/javimarlop/datasets/master/pictures/profile_tool.png)\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}